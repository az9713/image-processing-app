name: Test Image Processing App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16, 18, 20]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Install test dependencies
      run: |
        npm install -g http-server
        
    - name: Verify project structure
      run: |
        echo "ğŸ” Verifying project structure..."
        
        # Check required directories
        test -d css && echo "âœ… css/ directory exists" || (echo "âŒ Missing css/ directory" && exit 1)
        test -d js && echo "âœ… js/ directory exists" || (echo "âŒ Missing js/ directory" && exit 1)
        test -d lib && echo "âœ… lib/ directory exists" || (echo "âŒ Missing lib/ directory" && exit 1)
        test -d images && echo "âœ… images/ directory exists" || (echo "âŒ Missing images/ directory" && exit 1)
        
        # Check required files
        test -f index.html && echo "âœ… index.html exists" || (echo "âŒ Missing index.html" && exit 1)
        test -f README.md && echo "âœ… README.md exists" || (echo "âŒ Missing README.md" && exit 1)
        test -f package.json && echo "âœ… package.json exists" || (echo "âŒ Missing package.json" && exit 1)
        
    - name: Validate HTML structure
      run: |
        echo "ğŸ” Validating HTML structure..."
        
        # Check for essential HTML elements
        grep -q "<!DOCTYPE html>" index.html && echo "âœ… Valid DOCTYPE" || (echo "âŒ Invalid or missing DOCTYPE" && exit 1)
        grep -q "<html.*lang=" index.html && echo "âœ… Language attribute present" || echo "âš ï¸ Language attribute missing"
        grep -q "<meta.*viewport" index.html && echo "âœ… Viewport meta tag present" || echo "âš ï¸ Viewport meta tag missing"
        grep -q "<title>" index.html && echo "âœ… Title tag present" || (echo "âŒ Title tag missing" && exit 1)
        
        # Check for required application elements
        grep -q 'id="uploadBtn"' index.html && echo "âœ… Upload button present" || (echo "âŒ Upload button missing" && exit 1)
        grep -q 'id="originalCanvas"' index.html && echo "âœ… Original canvas present" || (echo "âŒ Original canvas missing" && exit 1)
        grep -q 'id="processedCanvas"' index.html && echo "âœ… Processed canvas present" || (echo "âŒ Processed canvas missing" && exit 1)
        grep -q 'id="qualitySlider"' index.html && echo "âœ… Quality slider present" || (echo "âŒ Quality slider missing" && exit 1)
        
    - name: Validate CSS
      run: |
        echo "ğŸ” Validating CSS..."
        
        test -f css/styles.css && echo "âœ… Main stylesheet exists" || (echo "âŒ Main stylesheet missing" && exit 1)
        
        # Check for essential CSS classes
        grep -q "\.app-container" css/styles.css && echo "âœ… App container styles present" || echo "âš ï¸ App container styles missing"
        grep -q "\.image-display" css/styles.css && echo "âœ… Image display styles present" || echo "âš ï¸ Image display styles missing"
        grep -q "\.processing-controls" css/styles.css && echo "âœ… Processing control styles present" || echo "âš ï¸ Processing control styles missing"
        
        # Check for responsive design
        grep -q "@media" css/styles.css && echo "âœ… Responsive design present" || echo "âš ï¸ No responsive design detected"
        
    - name: Validate JavaScript
      run: |
        echo "ğŸ” Validating JavaScript..."
        
        # Check all JavaScript files exist
        required_js_files=("app.js" "formatHandler.js" "imageProcessor.js" "processingPipeline.js" "uiController.js")
        
        for file in "${required_js_files[@]}"; do
          if test -f "js/$file"; then
            echo "âœ… js/$file exists"
            # Basic syntax check
            node -c "js/$file" && echo "  âœ… Syntax valid" || (echo "  âŒ Syntax error in js/$file" && exit 1)
          else
            echo "âŒ Missing js/$file"
            exit 1
          fi
        done
        
        # Check for required JavaScript classes/functions
        grep -q "class.*App" js/app.js && echo "âœ… Main app class found" || echo "âš ï¸ Main app class not found"
        grep -q "class.*FormatHandler" js/formatHandler.js && echo "âœ… Format handler class found" || echo "âš ï¸ Format handler class not found"
        grep -q "class.*ImageProcessor" js/imageProcessor.js && echo "âœ… Image processor class found" || echo "âš ï¸ Image processor class not found"
        
    - name: Test server startup
      run: |
        echo "ğŸ” Testing server startup..."
        
        # Start HTTP server in background
        http-server . -p 8080 -s &
        SERVER_PID=$!
        
        # Wait for server to start
        sleep 3
        
        # Test if server is responding
        if curl -f -s http://localhost:8080/ > /dev/null; then
          echo "âœ… Server started successfully"
          
          # Test if main page loads
          if curl -f -s http://localhost:8080/ | grep -q "Image Processing Application"; then
            echo "âœ… Main page loads correctly"
          else
            echo "âŒ Main page content not found"
            kill $SERVER_PID
            exit 1
          fi
          
          # Test if resources are accessible
          curl -f -s http://localhost:8080/css/styles.css > /dev/null && echo "âœ… CSS accessible" || echo "âš ï¸ CSS not accessible"
          curl -f -s http://localhost:8080/js/app.js > /dev/null && echo "âœ… JavaScript accessible" || echo "âš ï¸ JavaScript not accessible"
          
        else
          echo "âŒ Server failed to start or not responding"
          kill $SERVER_PID
          exit 1
        fi
        
        # Clean up
        kill $SERVER_PID
        
    - name: Check documentation
      run: |
        echo "ğŸ” Checking documentation..."
        
        # Check README content
        grep -q "Image Processing Application" README.md && echo "âœ… README has project title" || echo "âš ï¸ README missing project title"
        grep -q "Installation" README.md && echo "âœ… README has installation instructions" || echo "âš ï¸ README missing installation instructions"
        grep -q "Usage" README.md && echo "âœ… README has usage instructions" || echo "âš ï¸ README missing usage instructions"
        
        # Check for installation scripts
        test -f install.sh && echo "âœ… Linux/macOS install script present" || echo "âš ï¸ Linux/macOS install script missing"
        test -f install.bat && echo "âœ… Windows install script present" || echo "âš ï¸ Windows install script missing"
        
    - name: Generate test report
      run: |
        echo "ğŸ“Š Test Report" >> $GITHUB_STEP_SUMMARY
        echo "==============" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Node.js Version**: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Test Status**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "**Test Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Tested:" >> $GITHUB_STEP_SUMMARY
        echo "- HTML structure and required elements" >> $GITHUB_STEP_SUMMARY
        echo "- CSS stylesheets and responsive design" >> $GITHUB_STEP_SUMMARY
        echo "- JavaScript syntax and core classes" >> $GITHUB_STEP_SUMMARY
        echo "- Server startup and resource accessibility" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation completeness" >> $GITHUB_STEP_SUMMARY